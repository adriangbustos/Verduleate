<!-- ============================================
     ADMIN CHAT INTERFACE - CENTRAL PANE
     ============================================ -->

<div class="chat-container">

  <!-- ==================== EMPTY STATE ==================== -->
  <div *ngIf="!selectedTicket" class="empty-state">
    <div class="empty-content">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
      </div>
      <h2>Selecciona una conversaciÃ³n</h2>
      <p>Elige un ticket de la lista para comenzar a chatear con el agricultor</p>
    </div>
  </div>

  <!-- ==================== ACTIVE CHAT ==================== -->
  <ng-container *ngIf="selectedTicket">
    
    <!-- Chat Header -->
    <header class="chat-header">
      <div class="header-left">
        <div class="farmer-avatar">
          {{ getInitials(selectedTicket.farmerName) }}
        </div>
        <div class="farmer-info">
          <h3 class="farmer-name">{{ selectedTicket.farmerName }}</h3>
          <div class="ticket-meta">
            <span class="ticket-id">#{{ selectedTicket.id?.substring(0, 8) }}</span>
            <span class="meta-separator">â€¢</span>
            <span class="ticket-status" [class.active]="selectedTicket.status === 'active'">
              {{ getStatusText(selectedTicket.status) }}
            </span>
            <span class="meta-separator">â€¢</span>
            <span class="ticket-date">{{ formatDate(selectedTicket.createdAt) }}</span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <button 
          *ngIf="selectedTicket.status === 'active'"
          class="btn-close-ticket"
          (click)="showCloseTicketDialog()"
          title="Cerrar ticket"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Resolver
        </button>

        <button class="btn-icon" title="MÃ¡s opciones">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="1"/>
            <circle cx="19" cy="12" r="1"/>
            <circle cx="5" cy="12" r="1"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Messages Area -->
    <div #messagesContainer class="messages-area">
      
      <!-- No Messages State -->
      <div *ngIf="messages.length === 0" class="no-messages">
        <div class="no-msg-icon">ğŸ’¬</div>
        <p>No hay mensajes en este ticket</p>
        <span class="no-msg-hint">EnvÃ­a el primer mensaje para comenzar la conversaciÃ³n</span>
      </div>

      <!-- Date Separator (First Message) -->
      <div *ngIf="messages.length > 0" class="date-separator">
        <span>{{ formatDate(messages[0].timestamp) }}</span>
      </div>

      <!-- Messages -->
      <div 
        *ngFor="let message of messages; let i = index"
        class="message-wrapper"
        [class.own]="isOwnMessage(message)"
        [class.other]="!isOwnMessage(message)"
      >
        <!-- Avatar for other messages -->
        <div *ngIf="!isOwnMessage(message)" class="message-avatar">
          {{ getInitials(message.senderName) }}
        </div>

        <div class="message-content">
          <!-- Sender Name (for other messages) -->
          <span *ngIf="!isOwnMessage(message)" class="sender-name">
            {{ message.senderName }}
          </span>

          <!-- Message Bubble -->
          <div class="message-bubble">
            <p class="message-text">{{ message.text }}</p>
            <span class="message-time">{{ formatTime(message.timestamp) }}</span>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div *ngIf="showTypingIndicator()" class="typing-indicator">
        <div class="typing-avatar">ğŸ‘¨â€ğŸŒ¾</div>
        <div class="typing-bubble">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

    </div>

    <!-- Message Input -->
    <div class="input-area">
      
      <!-- Error Banner -->
      <div *ngIf="error()" class="error-banner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        {{ error() }}
        <button class="btn-dismiss" (click)="error.set(null)">Ã—</button>
      </div>

      <!-- Closed Notice -->
      <div *ngIf="selectedTicket.status === 'closed'" class="closed-notice">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        Este ticket ha sido cerrado
      </div>

      <!-- Input Container -->
      <div class="input-container" *ngIf="selectedTicket.status !== 'closed'">
        <button class="btn-attach" title="Adjuntar archivo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
          </svg>
        </button>

        <div class="input-wrapper">
          <textarea
            class="message-input"
            placeholder="Escribe tu respuesta..."
            [value]="newMessageText()"
            (input)="newMessageText.set($any($event.target).value)"
            (keypress)="onKeyPress($event)"
            rows="1"
          ></textarea>
        </div>

        <button class="btn-emoji" title="AÃ±adir emoji">
          ğŸ˜Š
        </button>

        <button 
          class="btn-send"
          [disabled]="!newMessageText().trim()"
          (click)="sendMessage()"
          title="Enviar mensaje"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>

    </div>

  </ng-container>

</div>

<!-- Close Ticket Confirmation Dialog -->
<p-dialog 
  [draggable]="false" 
  [modal]="true" 
  [(visible)]="showCloseDialog"
  [style]="{width: '350px'}">
  <ng-template pTemplate="headless">
    <div class="close-dialog-card">
      <div class="close-dialog-header">
        <div class="close-dialog-image">
          <svg aria-hidden="true" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" fill="none">
            <path
              d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              stroke-linejoin="round" 
              stroke-linecap="round">
            </path>
          </svg>
        </div>
        <div class="close-dialog-content">
          <span class="close-dialog-title">Â¿Resolver ticket?</span>
          <p class="close-dialog-message">
            Â¿EstÃ¡s seguro de que deseas cerrar este ticket? 
            Esto marcarÃ¡ la conversaciÃ³n como resuelta.
          </p>
        </div>
        <div class="close-dialog-actions">
          <button class="btn-resolve" type="button" (click)="closeCurrentTicket()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Resolver
          </button>
          <button class="btn-cancel-dialog" type="button" (click)="closeDialog()">Cancelar</button>
        </div>
      </div>
    </div>
  </ng-template>
</p-dialog>
